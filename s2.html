<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABC Simulator (Frontend Only)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7}
    body{font-family:Inter,Segoe UI,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#071022 0%, #0f1724 100%);color:#e6eef6;margin:0;padding:20px}
    .container{max-width:980px;margin:0 auto}
    h1{font-size:20px;margin:6px 0 18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.6);margin-bottom:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{background:var(--accent);color:#022;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    pre{white-space:pre-wrap;background:#071224;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:#cde}
    .muted{color:var(--muted);font-size:13px}
    .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:#071a14;color:var(--accent);margin-right:6px;font-size:12px}
    .flex{display:flex;align-items:center;gap:8px}
    .small{font-size:13px}
    .log{max-height:220px;overflow:auto}
  </style>
</head>
<body>
  <div class="container">
    <h1>ABC Simulator — Frontend Demo</h1>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Simulate ABC credit uploads (no server required)</div>
          <strong>Build ABC JSON → Submit → Get token / status</strong>
        </div>
        <div class="small muted">Local only — data stored in browser</div>
      </div>
    </div>

    <div class="card">
      <label>Mode</label>
      <select id="mode">
        <option value="success">success (immediate UPLOADED)</option>
        <option value="pending">pending (becomes UPLOADED after delay)</option>
        <option value="failure">failure (returns error)</option>
      </select>

      <div style="height:12px"></div>

      <label>Student APAAR ID</label>
      <input id="apaar_id" type="text" placeholder="APAAR-IND-2025-001" value="APAAR-IND-2025-001" />

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>Student Name</label>
          <input id="student_name" type="text" value="Tanmay Sangrola" />
        </div>
        <div class="col">
          <label>Aadhaar-linked mobile</label>
          <input id="mobile" type="text" value="9876543210" />
        </div>
      </div>

      <div style="height:8px"></div>

      <label>Institution Code</label>
      <input id="institution_code" type="text" value="UPES001" />

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>Organization Name</label>
          <input id="organization_name" type="text" value="TechMahindra" />
        </div>
        <div class="col">
          <label>Internship Title</label>
          <input id="title" type="text" value="Cloud Infrastructure Deployment" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="col">
          <label>Start Date</label>
          <input id="start_date" type="text" value="2025-06-01" />
        </div>
        <div class="col">
          <label>End Date</label>
          <input id="end_date" type="text" value="2025-07-27" />
        </div>
        <div style="width:140px">
          <label>Total Hours</label>
          <input id="total_hours" type="number" value="200" />
        </div>
      </div>

      <div style="height:10px"></div>

      <label>Learning Outcomes (comma-separated)</label>
      <textarea id="learning_outcomes" rows="3">Cloud Fundamentals, DevOps Basics</textarea>

      <div style="height:12px"></div>

      <div style="display:flex;gap:8px">
        <button id="build">Build Payload</button>
        <button id="submit">Submit to Simulator</button>
        <button id="view_store">View Stored Records</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Request / Payload</strong></div>
        <div class="muted small">Payload built with credit rule: min(round(total_hours/120),6) and duration >= 2 weeks</div>
      </div>
      <div style="height:8px"></div>
      <pre id="payload">(no payload yet)</pre>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Simulator Response</strong></div>
        <div class="muted small">You can query status by token below</div>
      </div>
      <div style="height:8px"></div>
      <pre id="response">(no response yet)</pre>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Query Status by Token</strong></div>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <div class="col">
          <input id="query_token" type="text" placeholder="ABC-TOK-..." />
        </div>
        <div style="width:120px"><button id="qstatus">Query</button></div>
      </div>

      <div style="height:8px"></div>
      <pre id="qresult">(no query yet)</pre>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Local Store (submissions)</strong></div>
        <div class="muted small">Saved in browser localStorage for demo</div>
      </div>
      <div style="height:8px"></div>
      <div id="store" class="log muted">(empty)</div>
    </div>

    <div style="height:30px"></div>
    <div class="muted small">Tip: Use the &quot;pending&quot; mode to test a delayed upload. The simulator will flip PENDING → UPLOADED after the configured delay.</div>
  </div>

  <script>
    // helper: SHA-256 and hex
    async function sha256hex(message) {
      const enc = new TextEncoder();
      const data = enc.encode(message);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function computeCredits(totalHours, startDate, endDate) {
      // compute weeks
      try {
        const s = new Date(startDate);
        const e = new Date(endDate);
        const msPerWeek = 7*24*60*60*1000;
        const weeks = Math.max(0, Math.round((e - s) / msPerWeek));
        const credits = Math.min(Math.round(totalHours/120), 6);
        const eligible = weeks >= 2;
        return {credits, weeks, eligible};
      } catch(e) { return {credits:0,weeks:0,eligible:false}; }
    }

    function saveSubmission(record){
      const all = JSON.parse(localStorage.getItem('abc_sim_subs')||'[]');
      all.unshift(record);
      localStorage.setItem('abc_sim_subs', JSON.stringify(all));
      renderStore();
    }

    function renderStore(){
      const all = JSON.parse(localStorage.getItem('abc_sim_subs')||'[]');
      const el = document.getElementById('store');
      if(!all.length) { el.textContent='(empty)'; return }
      el.innerHTML = all.slice(0,50).map(s=>{
        return <div style="padding:8px;margin-bottom:8px;border-radius:8px;background:rgba(255,255,255,0.015)"><div style="display:flex;justify-content:space-between"><div><strong>${s.apaar_id}</strong> <span class="muted">(${s.student_name})</span></div><div class="muted">${s.status}</div></div><div class="muted small">token: ${s.abc_token || '—'}</div></div>
      }).join('');
    }

    document.getElementById('build').addEventListener('click', async ()=>{
      const payload = await buildPayload();
      document.getElementById('payload').textContent = JSON.stringify(payload, null, 2);
    });

    async function buildPayload(){
      const apa = document.getElementById('apaar_id').value.trim();
      const name = document.getElementById('student_name').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const inst = document.getElementById('institution_code').value.trim();
      const org = document.getElementById('organization_name').value.trim();
      const title = document.getElementById('title').value.trim();
      const start = document.getElementById('start_date').value.trim();
      const end = document.getElementById('end_date').value.trim();
      const hours = Number(document.getElementById('total_hours').value)||0;
      const outcomes = document.getElementById('learning_outcomes').value.split(',').map(s=>s.trim()).filter(Boolean);

      const cc = computeCredits(hours, start, end);

      const payload = {
        abc_id: Math.floor(Math.random()*1e12).toString(),
        apaar_id: apa,
        student_name: name,
        aadhaar_linked_mobile: mobile,
        institution_code: inst,
        institution_name: inst,
        internship_course_code: 'INT-2025-000',
        course_type: 'Internship',
        learning_mode: 'Blended',
        organization_name: org,
        duration_weeks: cc.weeks,
        total_hours: hours,
        credit_value: cc.eligible ? cc.credits : 0,
        academic_level: 'UG',
        academic_year: '2024-25',
        semester: 'Summer',
        status: cc.eligible ? 'Approved' : 'Not Eligible (duration < 2 weeks)',
        learning_outcomes: outcomes,
        equivalence_audit: {
          engine: 'CEESCM-Lite',
          composite_score: 0.78,
          decision: cc.eligible ? 'Equivalent' : 'Not Equivalent'
        }
      };

      return payload;
    }

    async function submitToSimulator(){
      const mode = document.getElementById('mode').value;
      const payload = await buildPayload();
      const json = JSON.stringify(payload);
      const hex = await sha256hex(json);
      const token = 'ABC-TOK-' + hex.slice(0,12);

      // build response depending on mode
      if(mode === 'failure'){
        const resp = {status: 'ERROR', code: 'SCHEMA_INVALID', message: 'Simulated failure: schema invalid'};
        document.getElementById('response').textContent = JSON.stringify(resp, null, 2);
        // store failure
        saveSubmission({apaar_id: payload.apaar_id, student_name: payload.student_name, abc_token: null, status: 'ERROR', payload, response: resp, created_at: new Date().toISOString()});
        return;
      }

      // success or pending
      const initialStatus = mode === 'pending' ? 'PENDING' : 'UPLOADED';
      const now = new Date().toISOString();
      const resp = {status: initialStatus, abc_token: token, received_at: now};

      document.getElementById('response').textContent = JSON.stringify(resp, null, 2);

      // save submission
      const record = {apaar_id: payload.apaar_id, student_name: payload.student_name, abc_token: token, status: initialStatus, payload, response: resp, created_at: now};
      saveSubmission(record);

      // If pending, schedule auto-flip
      if(mode === 'pending'){
        const flipSeconds = 10; // configurable
        setTimeout(()=>{
          // update record in localStorage
          const all = JSON.parse(localStorage.getItem('abc_sim_subs')||'[]');
          for(let r of all){ if(r.abc_token === token){ r.status = 'UPLOADED'; r.response = {status:'UPLOADED', abc_token: token, received_at: new Date().toISOString()}; r.updated_at = new Date().toISOString(); } }
          localStorage.setItem('abc_sim_subs', JSON.stringify(all));
          renderStore();
        }, flipSeconds*1000);
      }
    }

    document.getElementById('submit').addEventListener('click', async ()=>{
      await submitToSimulator();
    });

    document.getElementById('view_store').addEventListener('click', renderStore);

    document.getElementById('qstatus').addEventListener('click', ()=>{
      const token = document.getElementById('query_token').value.trim();
      if(!token){ document.getElementById('qresult').textContent = '(enter token)'; return }
      const all = JSON.parse(localStorage.getItem('abc_sim_subs')||'[]');
      const found = all.find(x=>x.abc_token === token);
      if(!found){ document.getElementById('qresult').textContent = 'not found'; return }
      document.getElementById('qresult').textContent = JSON.stringify({abc_token: found.abc_token, status: found.status, received_at: found.response && found.response.received_at}, null, 2);
    });

    // init
    renderStore();
  </script>
</body>
</html>